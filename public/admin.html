<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LivestockMart Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-6 px-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold flex items-center gap-2">
        <span class="inline-flex w-8 h-8 rounded-full bg-emerald-500 items-center justify-center">L</span>
        LivestockMart Admin
      </h1>
      <button id="reloadBtn" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm">
        <i data-lucide="refresh-ccw" class="w-4 h-4"></i><span>Reload</span>
      </button>
    </header>

    <section class="grid md:grid-cols-3 gap-4 mb-8">
      <div class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <p class="text-xs text-gray-400 mb-1">Total Livestock</p>
        <p id="stat-livestock" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <p class="text-xs text-gray-400 mb-1">Total Orders</p>
        <p id="stat-orders" class="text-2xl font-semibold">0</p>
      </div>
      <div class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <p class="text-xs text-gray-400 mb-1">Total Revenue</p>
        <p id="stat-revenue" class="text-2xl font-semibold">‚Çπ0</p>
      </div>
    </section>

    <div class="grid lg:grid-cols-2 gap-6">
      <!-- Livestock management -->
      <section class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold flex items-center gap-2">
            <i data-lucide="cow" class="w-4 h-4"></i> Livestock
          </h2>
          <button id="addLivestockBtn" class="text-xs px-2 py-1 rounded bg-emerald-600 hover:bg-emerald-700">
            + Add
          </button>
        </div>
        <form id="livestock-form" class="grid grid-cols-2 gap-2 mb-3 text-xs hidden">
          <input required name="name" placeholder="Name" class="col-span-1 rounded bg-gray-800 border border-gray-700 px-2 py-1">
          <select name="type" class="col-span-1 rounded bg-gray-800 border border-gray-700 px-2 py-1">
            <option value="Goat">Goat</option>
            <option value="Sheep">Sheep</option>
          </select>
          <input required name="breed" placeholder="Breed" class="col-span-1 rounded bg-gray-800 border border-gray-700 px-2 py-1">
          <input required name="age" placeholder="Age" class="col-span-1 rounded bg-gray-800 border border-gray-700 px-2 py-1">
          <input required name="price" type="number" min="0" placeholder="Price (‚Çπ)" class="col-span-2 rounded bg-gray-800 border border-gray-700 px-2 py-1">
          <input name="image" placeholder="Image emoji or URL" class="col-span-2 rounded bg-gray-800 border border-gray-700 px-2 py-1">
          <button class="col-span-2 mt-1 text-xs px-2 py-1.5 rounded bg-emerald-600 hover:bg-emerald-700">Save</button>
        </form>
        <div id="livestock-list" class="space-y-2 text-xs max-h-80 overflow-y-auto"></div>
      </section>

      <!-- Orders -->
      <section class="bg-gray-900/60 border border-gray-800 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold flex items-center gap-2">
            <i data-lucide="package" class="w-4 h-4"></i> Recent Orders
          </h2>
        </div>
        <div id="orders-list" class="space-y-2 text-xs max-h-96 overflow-y-auto"></div>
      </section>
    </div>
  </div>

<script>
const API_URL = '/api';

function formatINR(v) {
  const n = Number(v) || 0;
  return n.toLocaleString('en-IN');
}

async function fetchJSON(url, options={}) {
  const res = await fetch(url, { credentials: 'include', ...options });
  if (!res.ok) throw new Error('Request failed');
  return res.json();
}

async function loadDashboard() {
  try {
    const [livestock, orders] = await Promise.all([
      fetchJSON(API_URL + '/livestock'),
      fetchJSON(API_URL + '/orders')
    ]);

    document.getElementById('stat-livestock').textContent = livestock.length;
    document.getElementById('stat-orders').textContent = orders.length;
    const revenue = orders.reduce((s,o)=>s + (o.total || 0), 0);
    document.getElementById('stat-revenue').textContent = '‚Çπ' + formatINR(revenue);

    const lList = document.getElementById('livestock-list');
    lList.innerHTML = livestock.map(item => `
      <div class="flex items-center justify-between bg-gray-800/80 rounded px-2 py-1">
        <div class="flex items-center gap-2">
          <span class="text-lg">${item.image || 'üêê'}</span>
          <div>
            <p class="font-semibold">${item.name} <span class="text-gray-400 text-[10px]">(${item.type})</span></p>
            <p class="text-[10px] text-gray-400">${item.breed} ‚Ä¢ ${item.age}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs font-semibold">‚Çπ${formatINR(item.price)}</span>
          <button data-id="${item._id}" class="del-ls text-red-400 hover:text-red-200">
            <i data-lucide="trash-2" class="w-3 h-3"></i>
          </button>
        </div>
      </div>
    `).join('') || '<p class="text-[11px] text-gray-400">No livestock yet.</p>';

    const oList = document.getElementById('orders-list');
    oList.innerHTML = orders.slice(0,20).map(o => `
      <div class="bg-gray-800/80 rounded px-2 py-1.5">
        <div class="flex justify-between">
          <p class="font-semibold">#${String(o._id).slice(-6)} ‚Ä¢ ${o.customer}</p>
          <span class="text-[10px] px-2 py-0.5 rounded-full ${o.status === 'Delivered' ? 'bg-emerald-600/30 text-emerald-300' : 'bg-yellow-600/30 text-yellow-200'}">${o.status}</span>
        </div>
        <p class="text-[10px] text-gray-400">${o.items.map(i=>i.name).join(', ')}</p>
        <p class="text-[10px] text-gray-300 mt-1">‚Çπ${formatINR(o.total)} ‚Ä¢ ${o.date}</p>
      </div>
    `).join('') || '<p class="text-[11px] text-gray-400">No orders yet.</p>';

    lucide.createIcons();
  } catch (e) {
    console.error(e);
    alert('Failed to load admin data. Make sure you are logged in via user app.');
  }
}

async function addLivestock(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());
  const body = {
    name: data.name,
    type: data.type || 'Goat',
    breed: data.breed,
    age: data.age,
    price: Number(data.price) || 0,
    image: data.image || 'üêê',
    tags: []
  };
  try {
    await fetchJSON(API_URL + '/livestock', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    form.reset();
    form.classList.add('hidden');
    await loadDashboard();
  } catch (e) {
    console.error(e);
    alert('Failed to add livestock');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('reloadBtn').addEventListener('click', loadDashboard);
  document.getElementById('addLivestockBtn').addEventListener('click', () => {
    document.getElementById('livestock-form').classList.toggle('hidden');
  });
  document.getElementById('livestock-form').addEventListener('submit', addLivestock);
  document.getElementById('livestock-list').addEventListener('click', async (e) => {
    const btn = e.target.closest('.del-ls');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    if (!id) return;
    if (!confirm('Delete this livestock item?')) return;
    try {
      await fetchJSON(API_URL + '/livestock/' + id, { method: 'DELETE' });
      await loadDashboard();
    } catch (err) {
      console.error(err);
      alert('Failed to delete item');
    }
  });

  loadDashboard();
  setInterval(loadDashboard, 20000); // auto refresh every 20s
});
</script>
</body>
</html>
