<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivestockMart - User App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Updated CDN for better reliability) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .auth-glass {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(18px);
        }
        .auth-card {
            position: relative;
            overflow: hidden;
        }
        .auth-panel {
            transition: transform 0.45s ease, opacity 0.45s ease;
        }
        .auth-panel-register {
            position: absolute;
            inset: 0;
            transform: translateX(100%);
            opacity: 0;
        }
        .auth-card.show-register .auth-panel-login {
            transform: translateX(-100%);
            opacity: 0;
        }
        .auth-card.show-register .auth-panel-register {
            transform: translateX(0);
            opacity: 1;
        }

        /* Payment Gateway Styles */
        .pg-sidebar-item {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .pg-sidebar-item.active {
            background-color: white;
            border-left-color: #10b981;
            color: #10b981;
            font-weight: 600;
        }
        .pg-input {
            transition: border-color 0.2s;
        }
        .pg-input:focus {
            border-color: #10b981;
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="h-screen bg-gray-900 text-gray-100">

    <!-- Toast / popup messages -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none"></div>

    <!-- Address modal -->
    <div id="address-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md text-gray-800 shadow-2xl transform transition-all">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" id="address-modal-title">Shipping Address</h3>
                <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="address-form" class="space-y-3" onsubmit="submitAddress(event)">
                <div>
                    <label class="block text-xs font-medium text-gray-700">Full Name</label>
                    <input id="addr-name" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Phone Number</label>
                    <input id="addr-phone" type="tel" pattern="[0-9]{10}" maxlength="10"
                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                           placeholder="10-digit mobile number" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Address Line</label>
                    <textarea id="addr-line" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="2" required></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700">City</label>
                        <input id="addr-city" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700">State</label>
                        <input id="addr-state" type="text" class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700">Pincode</label>
                    <input id="addr-pincode" type="tel" pattern="[0-9]{6}" maxlength="6"
                           class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                           placeholder="6-digit pincode" required>
                </div>
                <div class="mt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeAddressModal()" class="px-4 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
                        Save & Continue
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Summary Modal -->
    <div id="order-summary-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl text-gray-800 shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-5 border-b flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800">Order Summary</h3>
                <button onclick="closeOrderSummary()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="overflow-y-auto p-6 space-y-6">
                 <!-- Address Section -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 relative group">
                    <div class="flex items-center gap-2 mb-2 text-emerald-700 font-semibold">
                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                        <h4>Delivery Address</h4>
                    </div>
                    <div id="order-address" class="text-sm text-gray-600 ml-6"></div>
                    <button onclick="changeAddress()" class="absolute top-4 right-4 text-xs bg-white border border-gray-300 px-3 py-1 rounded-full text-gray-600 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-200 transition">Change</button>
                </div>

                <!-- Order Items -->
                <div>
                    <h4 class="font-semibold mb-3 flex items-center gap-2">
                        <i data-lucide="package" class="w-4 h-4 text-gray-500"></i>
                        Items
                    </h4>
                    <div id="order-items" class="space-y-3"></div>
                </div>

                <!-- Price Details -->
                <div class="border-t pt-4">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-500">Subtotal</span>
                        <span id="order-subtotal" class="font-medium">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm mb-3">
                        <span class="text-gray-500">Delivery Charges</span>
                        <span id="order-delivery" class="text-green-600">FREE</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-gray-900 pt-3 border-t border-dashed">
                        <span>Total Payable</span>
                        <span id="order-total">₹0</span>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t bg-gray-50 flex justify-end gap-3">
                 <button onclick="closeOrderSummary()" class="px-6 py-2.5 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-100 transition">
                    Cancel
                </button>
                <button onclick="initiatePayment()" class="px-8 py-2.5 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center gap-2">
                    Proceed to Payment <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- NEW REALISTIC PAYMENT GATEWAY OVERLAY -->
    <div id="payment-gateway" class="fixed inset-0 z-50 hidden bg-gray-100 text-gray-800 flex flex-col font-sans">
        <!-- Gateway Header -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm flex justify-between items-center z-10">
            <div class="flex items-center gap-2">
                <div class="bg-emerald-600 text-white p-1.5 rounded font-bold text-lg">LM</div>
                <div>
                    <h2 class="text-lg font-bold text-gray-800 leading-tight">SecurePay</h2>
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">Verified Gateway</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-500">Total Amount</p>
                <p class="text-xl font-bold text-emerald-700" id="pg-total-display">₹0</p>
            </div>
        </div>

        <!-- Gateway Body -->
        <div class="flex-1 flex flex-col md:flex-row max-w-6xl mx-auto w-full p-4 md:p-8 gap-6">
            <!-- Sidebar Methods -->
            <div class="w-full md:w-1/4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col h-fit">
                <div class="p-4 bg-gray-100 border-b border-gray-200 font-medium text-gray-700 flex items-center gap-2">
                    <i data-lucide="wallet" class="w-4 h-4"></i> Payment Options
                </div>
                <div id="pg-methods" class="flex flex-col">
                    <button onclick="selectPGMethod('upi')" class="pg-sidebar-item active p-4 text-left text-sm hover:bg-white border-b border-gray-100 flex items-center justify-between">
                        <span class="flex items-center gap-3"><i data-lucide="smartphone" class="w-4 h-4"></i> UPI</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>
                    </button>
                    <button onclick="selectPGMethod('card')" class="pg-sidebar-item p-4 text-left text-sm hover:bg-white border-b border-gray-100 flex items-center justify-between">
                        <span class="flex items-center gap-3"><i data-lucide="credit-card" class="w-4 h-4"></i> Credit / Debit Card</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>
                    </button>
                    <button onclick="selectPGMethod('cod')" class="pg-sidebar-item p-4 text-left text-sm hover:bg-white flex items-center justify-between">
                        <span class="flex items-center gap-3"><i data-lucide="banknote" class="w-4 h-4"></i> Cash on Delivery</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>
                    </button>
                </div>
                <div class="p-4 mt-auto border-t border-gray-200 bg-gray-50 text-xs text-gray-400 text-center">
                    <div class="flex justify-center gap-2 mb-2 opacity-60">
                         <i data-lucide="shield-check" class="w-4 h-4"></i>
                         <i data-lucide="lock" class="w-4 h-4"></i>
                    </div>
                    100% Secure Payments
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-6 md:p-8 relative min-h-[400px]">
                <button onclick="closePaymentGateway()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-2">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>

                <!-- UPI View -->
                <div id="pg-view-upi" class="pg-view h-full flex flex-col">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <span class="text-emerald-600"><i data-lucide="smartphone" class="w-6 h-6"></i></span> UPI Payment
                    </h3>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <p class="text-sm font-medium mb-4">Pay via UPI App</p>
                            <div class="grid grid-cols-2 gap-3 mb-6">
                                <a id="btn-gpay" href="#" class="border border-gray-200 rounded-lg p-3 hover:border-emerald-500 hover:bg-emerald-50 flex flex-col items-center justify-center gap-2 transition">
                                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-xs">G</div>
                                    <span class="text-xs font-medium">Google Pay</span>
                                </a>
                                <a id="btn-phonepe" href="#" class="border border-gray-200 rounded-lg p-3 hover:border-emerald-500 hover:bg-emerald-50 flex flex-col items-center justify-center gap-2 transition">
                                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white font-bold text-xs">Pe</div>
                                    <span class="text-xs font-medium">PhonePe</span>
                                </a>
                                <a id="btn-paytm" href="#" class="border border-gray-200 rounded-lg p-3 hover:border-emerald-500 hover:bg-emerald-50 flex flex-col items-center justify-center gap-2 transition">
                                    <div class="w-8 h-8 rounded-full bg-blue-400 flex items-center justify-center text-white font-bold text-xs">Pay</div>
                                    <span class="text-xs font-medium">Paytm</span>
                                </a>
                                <a id="btn-bhim" href="#" class="border border-gray-200 rounded-lg p-3 hover:border-emerald-500 hover:bg-emerald-50 flex flex-col items-center justify-center gap-2 transition">
                                    <div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-xs">BHIM</div>
                                    <span class="text-xs font-medium">BHIM</span>
                                </a>
                            </div>

                            <div class="relative mb-6">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">OR</span></div>
                            </div>

                            <div class="space-y-3">
                                <label class="block text-sm font-medium text-gray-700">Enter UPI ID</label>
                                <div class="flex gap-2">
                                    <input type="text" placeholder="example@okhdfcbank" class="pg-input flex-1 border border-gray-300 rounded-lg px-4 py-2.5 text-sm">
                                    <button onclick="verifyAndPayUPI()" class="bg-emerald-600 text-white px-6 rounded-lg font-medium hover:bg-emerald-700 transition">Verify & Pay</button>
                                </div>
                                <p class="text-xs text-green-600 hidden flex items-center gap-1" id="upi-verified-msg"><i data-lucide="check-circle" class="w-3 h-3"></i> Verified User</p>
                            </div>
                        </div>

                        <!-- QR Code Section -->
                        <div class="bg-gray-50 rounded-xl p-6 flex flex-col items-center justify-center border border-dashed border-gray-300 text-center">
                            <p class="text-sm font-medium mb-4 text-gray-600">Scan QR to Pay</p>
                            <div class="bg-white p-2 rounded-lg shadow-sm mb-3">
                                <!-- Simulated QR Code -->
                                <div class="w-40 h-40 bg-gray-900 flex items-center justify-center text-white text-xs p-2 text-center">
                                    [ Dynamic QR Code ]<br>Amount: <span id="qr-amount"></span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">Scan with any UPI app</p>
                        </div>
                    </div>
                </div>

                <!-- Card View -->
                <div id="pg-view-card" class="pg-view hidden h-full max-w-lg">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                        <span class="text-emerald-600"><i data-lucide="credit-card" class="w-6 h-6"></i></span> Card Payment
                    </h3>
                    
                    <form onsubmit="processCard(event)" class="space-y-5">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Card Number</label>
                            <div class="relative">
                                <input type="text" placeholder="0000 0000 0000 0000" maxlength="19" class="pg-input w-full border border-gray-300 rounded-lg px-4 py-3 pl-12 text-sm font-mono tracking-wide" required>
                                <i data-lucide="credit-card" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400"></i>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Expiry Date</label>
                                <input type="text" placeholder="MM / YY" maxlength="5" class="pg-input w-full border border-gray-300 rounded-lg px-4 py-3 text-sm font-mono text-center" required>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 uppercase mb-1">CVV / CVC</label>
                                <div class="relative">
                                    <input type="password" placeholder="123" maxlength="3" class="pg-input w-full border border-gray-300 rounded-lg px-4 py-3 text-sm font-mono text-center" required>
                                    <i data-lucide="help-circle" class="absolute right-3 top-3.5 w-4 h-4 text-gray-400 cursor-help" title="3 digits on back of card"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Card Holder Name</label>
                            <input type="text" placeholder="Name as on card" class="pg-input w-full border border-gray-300 rounded-lg px-4 py-3 text-sm" required>
                        </div>

                        <div class="pt-4">
                            <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition">
                                Pay <span class="pg-pay-amount">₹0</span>
                            </button>
                            <p class="text-center text-xs text-gray-400 mt-3 flex items-center justify-center gap-1">
                                <i data-lucide="lock" class="w-3 h-3"></i> Encrypted & Secure
                            </p>
                        </div>
                    </form>
                </div>

                <!-- COD View -->
                <div id="pg-view-cod" class="pg-view hidden h-full flex flex-col items-center justify-center text-center">
                    <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 mb-6">
                        <i data-lucide="banknote" class="w-10 h-10"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Cash on Delivery</h3>
                    <p class="text-gray-500 mb-8 max-w-xs">Pay cash when your livestock arrives at your doorstep.</p>
                    <button onclick="processCOD()" class="bg-gray-800 text-white px-8 py-3 rounded-lg font-bold hover:bg-gray-900 transition flex items-center gap-2">
                        Confirm Order <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay (Bank Page Simulation) -->
    <div id="bank-processing" class="fixed inset-0 z-[60] hidden bg-white flex flex-col items-center justify-center font-sans">
        <div class="max-w-md w-full p-8 text-center">
            <div class="spinner border-4 border-emerald-500 border-t-transparent rounded-full w-16 h-16 mx-auto mb-6 animate-spin"></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Processing Payment</h2>
            <p class="text-gray-500 mb-8">Please do not close this window or press back...</p>
            
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-left shadow-inner">
                <div class="flex justify-between mb-4 pb-4 border-b border-gray-200">
                    <span class="text-gray-500 text-sm">Merchant</span>
                    <span class="font-semibold text-gray-800">LivestockMart</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-500 text-sm">Transaction ID</span>
                    <span class="font-mono text-xs bg-gray-200 px-2 py-1 rounded">TXN73829103</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500 text-sm">Amount</span>
                    <span class="font-bold text-emerald-600 pg-pay-amount">₹0</span>
                </div>
            </div>
            
            <div id="otp-simulation" class="hidden mt-8 text-left animate-fade-in">
                 <label class="block text-sm font-medium text-gray-700 mb-2">Enter Bank OTP</label>
                 <div class="flex gap-2">
                     <input type="text" value="123456" class="flex-1 border border-gray-300 rounded px-3 py-2 text-center tracking-widest font-mono" readonly>
                     <button onclick="finalizePayment()" class="bg-emerald-600 text-white px-4 py-2 rounded font-medium hover:bg-emerald-700">Submit</button>
                 </div>
                 <p class="text-xs text-gray-400 mt-2">Simulated: OTP auto-filled for demo</p>
            </div>
        </div>
    </div>

    <!-- Order Success Full Screen -->
    <div id="order-success-screen" class="fixed inset-0 z-[70] hidden bg-emerald-600 flex items-center justify-center text-white">
        <div class="text-center p-8 max-w-lg animate-bounce-in">
            <div class="w-24 h-24 bg-white text-emerald-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-6 shadow-xl">
                <i data-lucide="check" class="w-12 h-12"></i>
            </div>
            <h1 class="text-4xl font-bold mb-4">Order Placed!</h1>
            <p class="text-emerald-100 text-lg mb-8">Thank you for your purchase. Your livestock will be shipped shortly.</p>
            <button onclick="closeSuccessScreen()" class="bg-white text-emerald-700 px-8 py-3 rounded-full font-bold shadow-lg hover:bg-emerald-50 hover:scale-105 transition transform">
                View My Orders
            </button>
        </div>
    </div>


    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden fixed inset-0 z-20 flex items-center justify-center px-4 bg-gradient-to-br from-green-900 via-gray-900 to-black">
        <div class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
            <!-- Left: marketing -->
            <div class="hidden md:flex flex-col justify-between text-white">
                <div>
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center font-bold text-lg">
                            L
                        </div>
                        <span class="text-2xl font-bold tracking-tight">LivestockMart</span>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold leading-tight mb-4">
                        Manage your goats & sheep<br>like a modern marketplace.
                    </h1>
                    <p class="text-sm text-emerald-100/80">
                        Realtime livestock listings, smart orders, and a smooth shopping experience.
                    </p>
                </div>
                <div class="flex items-center gap-3 text-xs text-emerald-100/70 mt-8">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Secure authentication • MongoDB</span>
                </div>
            </div>

            <!-- Right: auth card -->
            <div id="auth-card" class="auth-card auth-glass rounded-3xl p-6 sm:p-8 shadow-2xl border border-white/10">
                <!-- LOGIN -->
                <div class="auth-panel auth-panel-login">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center">
                            <i data-lucide="lock" class="w-4 h-4 text-emerald-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-white">Welcome back</h2>
                            <p class="text-xs text-gray-300">Sign in to your dashboard</p>
                        </div>
                    </div>
                    <form id="login-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Email</label>
                            <input id="login-email" type="email" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Password</label>
                            <input id="login-password" type="password" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition">
                            <span>Sign in</span>
                        </button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex justify-between">
                        <span>New here?</span>
                        <button onclick="switchAuthView('register')" class="text-emerald-300 font-medium">Create an account</button>
                    </div>
                </div>

                <!-- REGISTER -->
                <div class="auth-panel auth-panel-register">
                     <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center">
                            <i data-lucide="user-plus" class="w-4 h-4 text-emerald-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-white">Create account</h2>
                            <p class="text-xs text-gray-300">Join LivestockMart today</p>
                        </div>
                    </div>
                    <form id="register-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Full Name</label>
                            <input id="register-name" type="text" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Email</label>
                            <input id="register-email" type="email" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Password</label>
                            <input id="register-password" type="password" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition">
                            <span>Create account</span>
                        </button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex justify-between">
                        <span>Already registered?</span>
                        <button onclick="switchAuthView('login')" class="text-emerald-300 font-medium">Back to login</button>
                    </div>
                </div>
                <div id="auth-error" class="mt-4 text-xs text-red-300 hidden"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="user-app" class="hidden h-screen w-full bg-gray-50 text-gray-800 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-10 hidden md:flex">
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg shadow-green-200">L</div>
                <span class="text-xl font-bold text-gray-800">LivestockMart</span>
            </div>
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto pt-4">
                <button onclick="router('browse')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="store" class="w-5 h-5"></i> Browse Livestock
                </button>
                <button onclick="router('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </button>
                <button onclick="router('cart')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i> Cart
                    <span id="cart-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden shadow-sm">0</span>
                </button>
                <button onclick="router('orders')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="package-check" class="w-5 h-5"></i> My Orders
                </button>
                <button onclick="router('wishlist')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="heart" class="w-5 h-5"></i> Wishlist
                </button>
                <button onclick="router('addresses')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="map-pin" class="w-5 h-5"></i> Addresses
                </button>
                <button onclick="router('profile')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-xl transition-all">
                    <i data-lucide="user-circle" class="w-5 h-5"></i> Profile
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative overflow-hidden">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center z-10 sticky top-0 shadow-sm">
                <div>
                    <h1 id="page-title" class="text-2xl font-bold text-gray-800 tracking-tight">Dashboard</h1>
                    <p class="text-xs text-gray-500 mt-1" id="current-date"></p>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative cursor-pointer hover:bg-gray-100 p-2 rounded-full transition" onclick="router('cart')">
                        <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600"></i>
                        <span id="header-cart-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden ring-2 ring-white">0</span>
                    </div>

                    <div class="relative">
                        <button id="profile-button" onclick="toggleProfileMenu()" class="flex items-center gap-3 focus:outline-none group">
                            <div id="profile-avatar" class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold shadow-md group-hover:shadow-lg transition">U</div>
                        </button>
                        <div id="profile-menu" class="absolute right-0 mt-3 w-48 bg-white border border-gray-100 rounded-xl shadow-xl py-2 hidden animate-fade-in z-50">
                            <div class="px-4 py-3 border-b border-gray-100 mb-2">
                                <p id="profile-name" class="text-sm font-bold text-gray-800">User</p>
                                <p class="text-xs text-gray-500">Member</p>
                            </div>
                            <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Views -->
            <div id="content-area" class="flex-1 overflow-y-auto p-6 md:p-8 bg-gray-50 hide-scrollbar">
                
                <div id="view-dashboard" class="space-y-8">
                     <!-- Stats Grid -->
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                         <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                             <div class="flex justify-between items-start">
                                 <div>
                                     <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Total Orders</p>
                                     <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-orders">0</h3>
                                 </div>
                                 <div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i data-lucide="package" class="w-6 h-6"></i></div>
                             </div>
                         </div>
                         <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                             <div class="flex justify-between items-start">
                                 <div>
                                     <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Spent</p>
                                     <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-spent">₹0</h3>
                                 </div>
                                 <div class="p-3 bg-green-50 text-green-600 rounded-xl"><i data-lucide="indian-rupee" class="w-6 h-6"></i></div>
                             </div>
                         </div>
                         <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                             <div class="flex justify-between items-start">
                                 <div>
                                     <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Wishlist</p>
                                     <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-wishlist">0</h3>
                                 </div>
                                 <div class="p-3 bg-pink-50 text-pink-600 rounded-xl"><i data-lucide="heart" class="w-6 h-6"></i></div>
                             </div>
                         </div>
                         <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition">
                             <div class="flex justify-between items-start">
                                 <div>
                                     <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">In Cart</p>
                                     <h3 class="text-3xl font-bold text-gray-800 mt-2" id="dash-total-cart">0</h3>
                                 </div>
                                 <div class="p-3 bg-orange-50 text-orange-600 rounded-xl"><i data-lucide="shopping-cart" class="w-6 h-6"></i></div>
                             </div>
                         </div>
                     </div>
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                         <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between">
                             <h3 class="font-bold text-lg text-gray-800">Recent Activity</h3>
                             <button onclick="router('orders')" class="text-sm text-emerald-600 font-medium hover:underline">View All</button>
                         </div>
                         <div id="dash-recent-orders" class="p-6 space-y-4"></div>
                     </div>
                </div>

                <div id="view-browse" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row gap-4 justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="renderBrowse()" placeholder="Search livestock..." class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="filterCategory('All')" class="filter-btn px-5 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium shadow-lg shadow-gray-200 transition">All</button>
                            <button onclick="filterCategory('Goat')" class="filter-btn px-5 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 transition">Goats</button>
                            <button onclick="filterCategory('Sheep')" class="filter-btn px-5 py-2 bg-white border border-gray-200 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 transition">Sheep</button>
                        </div>
                    </div>
                    <div id="livestock-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </div>

                <div id="view-cart" class="hidden space-y-6">
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-lg">My Cart <span id="cart-count-title" class="text-gray-400 text-sm font-normal ml-2">(0 items)</span></h3>
                        </div>
                        <div id="cart-items-container" class="p-6 space-y-6 min-h-[200px]"></div>
                        <div class="bg-gray-50 p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Total Amount</p>
                                <h3 class="text-2xl font-bold text-gray-800"><span id="cart-total">₹0</span></h3>
                            </div>
                            <button onclick="checkout()" class="w-full md:w-auto px-8 py-3 bg-gray-900 text-white rounded-xl font-medium hover:bg-black shadow-lg hover:shadow-xl transition transform active:scale-95">
                                Checkout Now
                            </button>
                        </div>
                     </div>
                </div>

                <div id="view-orders" class="hidden space-y-6">
                    <h3 class="font-bold text-xl mb-4">Order History</h3>
                    <div id="orders-list-full" class="space-y-4"></div>
                </div>

                <div id="view-wishlist" class="hidden space-y-6">
                     <h3 class="font-bold text-xl mb-4">My Wishlist</h3>
                     <div id="wishlist-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-addresses" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-xl">Saved Addresses</h3>
                        <button onclick="openAddressModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-md hover:bg-emerald-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add New
                        </button>
                    </div>
                    <div id="addresses-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div id="view-profile" class="hidden max-w-xl">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-xl mb-6">Profile Settings</h3>
                        <div class="space-y-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input id="profile-name-input" type="text" disabled class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input id="profile-email-input" type="email" disabled class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-gray-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api';
        let livestock = [], orders = [], cart = [], wishlist = [], addresses = [];
        let currentCategory = 'All', currentUser = null, appInitialized = false;
        let currentAddress = null, pendingCheckoutItems = null, editingAddressIndex = -1;
        let currentOrderItems = [];
        let currentPaymentMethod = 'upi';

        function refreshIcons() {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

        function formatINR(val) { return '₹' + (Number(val) || 0).toLocaleString('en-IN'); }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', warning: 'bg-amber-500', info: 'bg-gray-800' };
            div.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg transform transition-all duration-300 translate-x-full flex items-center gap-3 min-w-[300px]`;
            div.innerHTML = `<i data-lucide="${type==='success'?'check-circle':type==='error'?'alert-triangle':'info'}" class="w-5 h-5"></i><span>${msg}</span>`;
            container.appendChild(div);
            refreshIcons();
            requestAnimationFrame(() => div.classList.remove('translate-x-full'));
            setTimeout(() => {
                div.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => div.remove(), 300);
            }, 3000);
        }

        // --- AUTH & STATE ---
        async function loadUserState() {
            try {
                const res = await fetch(`${API_URL}/user/state`);
                if(res.ok) {
                    const data = await res.json();
                    cart = data.cart || [];
                    wishlist = data.wishlist || [];
                    addresses = data.addresses || [];
                    if(!currentAddress && addresses.length > 0) currentAddress = addresses[0];
                }
            } catch(e) { console.error(e); }
        }

        async function saveUserState() {
            try {
                await fetch(`${API_URL}/user/state`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cart, wishlist, addresses})
                });
            } catch(e) {}
        }

        // --- AUTH UI ---
        function switchAuthView(mode) {
            const card = document.getElementById('auth-card');
            if (mode === 'register') card.classList.add('show-register');
            else card.classList.remove('show-register');
        }

        function toggleProfileMenu() {
            document.getElementById('profile-menu').classList.toggle('hidden');
        }

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`);
                if(res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    await loadUserState();
                    updateProfileUI();
                    initApp();
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            } catch(e) {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const res = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({email, password})
            });
            const data = await res.json();
            if(res.ok) {
                currentUser = data.user;
                await loadUserState();
                updateProfileUI();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-app').classList.remove('hidden');
                initApp();
                showToast('Welcome back!', 'success');
            } else {
                showToast(data.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const res = await fetch(`${API_URL}/auth/register`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({name, email, password})
            });
            const data = await res.json();
            if(res.ok) {
                currentUser = data.user;
                await loadUserState();
                updateProfileUI();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-app').classList.remove('hidden');
                initApp();
                showToast('Account created successfully', 'success');
            } else {
                showToast(data.message, 'error');
            }
        }

        async function handleLogout() {
            await fetch(`${API_URL}/auth/logout`, {method:'POST'});
            window.location.reload();
        }

        function updateProfileUI() {
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-avatar').innerText = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('profile-name-input').value = currentUser.name;
            document.getElementById('profile-email-input').value = currentUser.email;
        }

        // --- APP LOGIC ---
        async function loadData() {
            const [lsRes, ordRes] = await Promise.all([
                fetch(`${API_URL}/livestock`),
                fetch(`${API_URL}/orders`)
            ]);
            livestock = await lsRes.json();
            orders = await ordRes.json();
            renderDashboard();
            renderBrowse();
        }

        function initApp() {
            if(appInitialized) return;
            appInitialized = true;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('user-app').classList.remove('hidden');
            const d = new Date();
            document.getElementById('current-date').innerText = d.toLocaleDateString('en-IN', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            
            router('dashboard');
        }

        function router(view) {
            loadData();
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            // Update Title
            const titles = {
                'dashboard': 'Dashboard', 'browse': 'Browse Livestock', 
                'cart': 'Shopping Cart', 'orders': 'My Orders', 
                'wishlist': 'My Wishlist', 'addresses': 'My Addresses', 'profile': 'Profile'
            };
            document.getElementById('page-title').innerText = titles[view];

            // Update Nav
            document.querySelectorAll('.nav-item').forEach(btn => {
                if(btn.getAttribute('onclick').includes(view)) {
                    btn.classList.add('bg-green-600', 'text-white', 'shadow-md', 'shadow-green-100');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-green-600', 'text-white', 'shadow-md', 'shadow-green-100');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            if(view === 'cart') renderCart();
            if(view === 'wishlist') renderWishlist();
            if(view === 'addresses') renderAddresses();
            if(view === 'orders') renderOrders();

            updateCartCount();
            refreshIcons();
        }

        // --- RENDERERS ---
        function renderDashboard() {
            const safeOrders = Array.isArray(orders) ? orders : [];
            const spent = safeOrders.reduce((acc, o) => acc + (o.total || 0), 0);
            document.getElementById('dash-total-orders').innerText = safeOrders.length;
            document.getElementById('dash-total-spent').innerText = formatINR(spent);
            document.getElementById('dash-total-wishlist').innerText = wishlist.length;
            document.getElementById('dash-total-cart').innerText = cart.length;

            const recentHTML = safeOrders.slice(0, 3).map(o => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-gray-200 text-lg shadow-sm">📦</div>
                        <div>
                            <p class="font-bold text-sm">Order #${String(o._id).slice(-6)}</p>
                            <p class="text-xs text-gray-500">${o.date}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">${formatINR(o.total)}</p>
                        <span class="text-[10px] uppercase font-bold tracking-wide text-green-600 bg-green-100 px-2 py-0.5 rounded-full">${o.status}</span>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 text-sm italic">No recent activity.</p>';
            
            document.getElementById('dash-recent-orders').innerHTML = recentHTML;
        }

        function filterCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.innerText === cat || (cat === 'All' && btn.innerText === 'All')) {
                    btn.classList.add('bg-gray-800', 'text-white', 'shadow-lg');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border');
                } else {
                    btn.classList.remove('bg-gray-800', 'text-white', 'shadow-lg');
                    btn.classList.add('bg-white', 'text-gray-600', 'border');
                }
            });
            renderBrowse();
        }

        function renderBrowse() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = livestock.filter(i => 
                (currentCategory === 'All' || i.type === currentCategory) &&
                (i.name.toLowerCase().includes(search) || i.breed.toLowerCase().includes(search))
            );
            
            const grid = document.getElementById('livestock-grid');
            if(!filtered.length) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">No livestock found.</div>';
                return;
            }

            grid.innerHTML = filtered.map(item => {
                const inWish = wishlist.includes(item._id);
                return `
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-xl transition-all duration-300 group overflow-hidden">
                    <div class="h-48 bg-gray-100 flex items-center justify-center text-7xl relative group-hover:bg-gray-200 transition">
                        ${item.image}
                        <button onclick="toggleWishlist('${item._id}')" class="absolute top-3 right-3 p-2 bg-white rounded-full shadow-md hover:scale-110 transition z-10 ${inWish ? 'text-red-500' : 'text-gray-400'}">
                            <i data-lucide="heart" class="w-5 h-5 ${inWish ? 'fill-current' : ''}"></i>
                        </button>
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800 line-clamp-1">${item.name}</h4>
                                <p class="text-xs text-gray-500 font-medium">${item.breed} • ${item.age}</p>
                            </div>
                            <span class="bg-gray-900 text-white text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider">${item.type}</span>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                            <span class="text-xl font-bold text-emerald-700">${formatINR(item.price)}</span>
                            <div class="flex gap-2">
                                <button onclick="buyNow('${item._id}')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-700 transition">Buy</button>
                                <button onclick="addToCart('${item._id}')" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm hover:bg-gray-200 transition"><i data-lucide="shopping-cart" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
            refreshIcons();
        }

        function renderCart() {
            const container = document.getElementById('cart-items-container');
            if(cart.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400">Your cart is empty.</div>';
                document.getElementById('cart-total').innerText = '₹0';
                return;
            }

            const total = cart.filter(i => i.selected !== false).reduce((acc, i) => acc + (i.price || 0), 0);
            document.getElementById('cart-total').innerText = formatINR(total);
            document.getElementById('cart-count-title').innerText = `(${cart.length} items)`;

            container.innerHTML = cart.map((item, idx) => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-4">
                        <input type="checkbox" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500" ${item.selected!==false?'checked':''} onchange="toggleCartSelect(${idx}, this.checked)">
                        <div class="w-16 h-16 bg-white rounded-lg flex items-center justify-center text-3xl shadow-sm border border-gray-200">${item.image}</div>
                        <div>
                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                            <p class="text-sm text-gray-500">${item.breed}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <p class="font-bold text-gray-800">${formatINR(item.price)}</p>
                        <button onclick="removeFromCart(${idx})" class="text-red-500 hover:bg-red-50 p-2 rounded-full transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        }

        function renderOrders() {
            const list = document.getElementById('orders-list-full');
            if(!orders || !orders.length) {
                list.innerHTML = '<div class="text-center py-12 text-gray-400">No orders placed yet.</div>';
                return;
            }
            list.innerHTML = orders.map(o => `
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex gap-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-2xl">📦</div>
                        <div>
                            <p class="font-bold text-lg">Order #${String(o._id).slice(-6)}</p>
                            <p class="text-sm text-gray-500">${o.items.length} items • ${o.date}</p>
                            <div class="flex gap-2 mt-1">
                                <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-600">${o.paymentMethod.toUpperCase()}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right w-full md:w-auto">
                        <p class="text-xl font-bold text-emerald-700">${formatINR(o.total)}</p>
                        <div class="flex items-center gap-2 justify-end mt-1">
                             <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold uppercase tracking-wide">${o.status}</span>
                             ${o.status === 'Processing' ? `<button onclick="cancelOrder('${o._id}')" class="text-xs text-red-500 underline hover:text-red-700">Cancel</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        }
        
        function renderWishlist() {
            const grid = document.getElementById('wishlist-grid');
            const items = livestock.filter(i => wishlist.includes(i._id));
            if(!items.length) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">Wishlist is empty.</div>';
                return;
            }
            grid.innerHTML = items.map(item => `
                <div class="bg-white rounded-xl border border-gray-200 p-4 relative shadow-sm">
                    <button onclick="toggleWishlist('${item._id}')" class="absolute top-2 right-2 p-1.5 bg-gray-100 rounded-full text-red-500 hover:bg-red-50">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    <div class="h-32 bg-gray-50 rounded-lg flex items-center justify-center text-5xl mb-3">${item.image}</div>
                    <h4 class="font-bold">${item.name}</h4>
                    <div class="flex justify-between items-center mt-3">
                        <span class="font-bold text-emerald-600">${formatINR(item.price)}</span>
                        <button onclick="addToCart('${item._id}')" class="text-xs bg-gray-900 text-white px-3 py-1.5 rounded-lg">Add Cart</button>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        }

        function renderAddresses() {
            const div = document.getElementById('addresses-container');
            if(!addresses.length) {
                div.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400 border border-dashed border-gray-300 rounded-lg">No saved addresses.</div>';
                return;
            }
            div.innerHTML = addresses.map((a, i) => `
                <div class="border border-gray-200 rounded-xl p-4 bg-white hover:border-emerald-500 transition relative group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-gray-100 text-xs font-bold px-2 py-0.5 rounded text-gray-600">${a.label}</span>
                        <button onclick="editAddress(${i})" class="text-blue-500 hover:bg-blue-50 p-1 rounded opacity-0 group-hover:opacity-100 transition"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    </div>
                    <p class="font-bold text-gray-800">${a.name}</p>
                    <p class="text-sm text-gray-600 mt-1 leading-relaxed">${a.line1}, ${a.city}, ${a.state} - ${a.pincode}</p>
                    <p class="text-sm text-gray-500 mt-1">Phone: ${a.phone}</p>
                </div>
            `).join('');
            refreshIcons();
        }

        // --- ACTIONS ---
        function addToCart(id) {
            const item = livestock.find(i => i._id === id);
            cart.push({...item, selected: true});
            updateCartCount();
            saveUserState();
            showToast('Added to cart', 'success');
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
            updateCartCount();
            saveUserState();
        }

        function toggleCartSelect(idx, val) {
            cart[idx].selected = val;
            renderCart();
            saveUserState();
        }

        function toggleWishlist(id) {
            const idx = wishlist.indexOf(id);
            if(idx > -1) wishlist.splice(idx, 1);
            else wishlist.push(id);
            saveUserState();
            renderBrowse();
            renderWishlist();
            if(wishlist.includes(id)) showToast('Added to wishlist', 'success');
            else showToast('Removed from wishlist', 'info');
            document.getElementById('dash-total-wishlist').innerText = wishlist.length;
        }

        function updateCartCount() {
            const count = cart.length;
            document.querySelectorAll('#cart-badge, #header-cart-badge').forEach(el => {
                el.innerText = count;
                if(count > 0) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            document.getElementById('dash-total-cart').innerText = count;
        }

        function buyNow(id) {
            const item = livestock.find(i => i._id === id);
            currentOrderItems = [{...item}];
            openOrderSummary();
        }

        function checkout() {
            const items = cart.filter(i => i.selected !== false);
            if(!items.length) return showToast('Cart is empty or no items selected', 'warning');
            currentOrderItems = items;
            openOrderSummary();
        }

        function openOrderSummary() {
            if(!addresses.length) {
                pendingCheckoutItems = currentOrderItems;
                openAddressModal();
                return;
            }
            if(!currentAddress) currentAddress = addresses[0];
            
            document.getElementById('order-summary-modal').classList.remove('hidden');
            document.getElementById('order-summary-modal').classList.add('flex');
            
            const subtotal = currentOrderItems.reduce((acc, i) => acc + (i.price || 0), 0);
            const delivery = subtotal > 5000 ? 0 : 200;
            
            document.getElementById('order-items').innerHTML = currentOrderItems.map(i => `
                <div class="flex justify-between items-center bg-white p-3 rounded border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-50 rounded flex items-center justify-center text-xl">${i.image}</div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">${i.name}</p>
                            <p class="text-xs text-gray-500">${i.breed}</p>
                        </div>
                    </div>
                    <span class="font-bold text-sm">${formatINR(i.price)}</span>
                </div>
            `).join('');

            document.getElementById('order-subtotal').innerText = formatINR(subtotal);
            document.getElementById('order-delivery').innerText = delivery === 0 ? 'FREE' : formatINR(delivery);
            document.getElementById('order-total').innerText = formatINR(subtotal + delivery);

            const addr = currentAddress;
            document.getElementById('order-address').innerHTML = `
                <p class="font-bold text-gray-800">${addr.name}</p>
                <p>${addr.line1}</p>
                <p>${addr.city}, ${addr.state} - ${addr.pincode}</p>
                <p>Ph: ${addr.phone}</p>
            `;
            refreshIcons();
        }

        function closeOrderSummary() {
            document.getElementById('order-summary-modal').classList.add('hidden');
            document.getElementById('order-summary-modal').classList.remove('flex');
        }

        function initiatePayment() {
            const subtotal = currentOrderItems.reduce((acc, i) => acc + (i.price || 0), 0);
            const total = subtotal + (subtotal > 5000 ? 0 : 200);
            
            // Setup Payment Gateway
            document.querySelectorAll('.pg-pay-amount').forEach(el => el.innerText = formatINR(total));
            document.getElementById('pg-total-display').innerText = formatINR(total);
            document.getElementById('qr-amount').innerText = formatINR(total);
            
            // Setup UPI Links (Real Intent)
            const upiParams = `pa=merchant@upi&pn=LivestockMart&am=${total}.00&cu=INR&tn=Order_${Date.now()}`;
            const upiLink = `upi://pay?${upiParams}`;
            
            document.getElementById('btn-gpay').href = upiLink;
            document.getElementById('btn-phonepe').href = upiLink;
            document.getElementById('btn-paytm').href = upiLink;
            document.getElementById('btn-bhim').href = upiLink;

            closeOrderSummary();
            document.getElementById('payment-gateway').classList.remove('hidden');
            selectPGMethod('upi'); // Default
            refreshIcons();
        }

        function closePaymentGateway() {
            document.getElementById('payment-gateway').classList.add('hidden');
        }

        function selectPGMethod(method) {
            currentPaymentMethod = method;
            document.querySelectorAll('.pg-sidebar-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`button[onclick="selectPGMethod('${method}')"]`).classList.add('active');
            
            document.querySelectorAll('.pg-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`pg-view-${method}`).classList.remove('hidden');
            refreshIcons();
        }

        function verifyAndPayUPI() {
            const btn = event.target;
            btn.innerText = 'Verifying...';
            setTimeout(() => {
                document.getElementById('upi-verified-msg').classList.remove('hidden');
                btn.innerText = 'Pay Now';
                btn.onclick = () => simulateBankRedirect();
            }, 1000);
        }

        function processCard(e) {
            e.preventDefault();
            simulateBankRedirect();
        }

        function processCOD() {
            finalizePayment();
        }

        function simulateBankRedirect() {
            document.getElementById('payment-gateway').classList.add('hidden');
            document.getElementById('bank-processing').classList.remove('hidden');
            document.getElementById('bank-processing').classList.add('flex');
            
            // Simulate Steps
            setTimeout(() => {
                document.getElementById('otp-simulation').classList.remove('hidden');
            }, 2000);
        }

        async function finalizePayment() {
            document.getElementById('bank-processing').classList.add('hidden');
            document.getElementById('bank-processing').classList.remove('flex');
            
            const subtotal = currentOrderItems.reduce((acc, i) => acc + (i.price || 0), 0);
            const total = subtotal + (subtotal > 5000 ? 0 : 200);

            const orderPayload = {
                date: new Date().toLocaleDateString(),
                items: currentOrderItems,
                total: total,
                status: 'Processing',
                paymentMethod: currentPaymentMethod,
                address: currentAddress
            };

            try {
                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(orderPayload)
                });
                if(res.ok) {
                    // Success Screen
                    document.getElementById('order-success-screen').classList.remove('hidden');
                    
                    // Cleanup Cart if applicable
                    if(cart.length > 0) {
                        const inOrderIds = currentOrderItems.map(i => i._id);
                        cart = cart.filter(c => !inOrderIds.includes(c._id) && c.selected === false);
                        saveUserState();
                        updateCartCount();
                    }
                    currentOrderItems = [];
                    loadData();
                }
            } catch(e) {
                showToast('Failed to place order', 'error');
            }
        }

        function closeSuccessScreen() {
            document.getElementById('order-success-screen').classList.add('hidden');
            router('orders');
        }

        // --- ADDRESS LOGIC ---
        function openAddressModal() {
            document.getElementById('address-modal').classList.remove('hidden');
            document.getElementById('address-modal').classList.add('flex');
        }
        function closeAddressModal() {
            document.getElementById('address-modal').classList.add('hidden');
            document.getElementById('address-modal').classList.remove('flex');
        }
        function submitAddress(e) {
            e.preventDefault();
            const addr = {
                name: document.getElementById('addr-name').value,
                phone: document.getElementById('addr-phone').value,
                line1: document.getElementById('addr-line').value,
                city: document.getElementById('addr-city').value,
                state: document.getElementById('addr-state').value,
                pincode: document.getElementById('addr-pincode').value,
                label: 'Home'
            };
            addresses.push(addr);
            saveUserState();
            closeAddressModal();
            renderAddresses();
            if(pendingCheckoutItems) {
                currentOrderItems = pendingCheckoutItems;
                pendingCheckoutItems = null;
                openOrderSummary();
            }
        }
        
        function changeAddress() {
            closeOrderSummary();
            pendingCheckoutItems = currentOrderItems;
            openAddressModal();
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            refreshIcons();
        });
    </script>
</body>
</html>
