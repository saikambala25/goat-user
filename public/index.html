
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LivestockMart - User Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes stepPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34,197,94,0.5); }
      70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34,197,94,0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    .step-active { animation: stepPulse 1.4s ease-out infinite; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- AUTH SCREEN -->
  <div id="auth-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-600 via-emerald-500 to-emerald-700 px-4">
    <div class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch">
      <div class="hidden md:flex flex-col justify-between text-white">
        <div>
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center font-bold text-lg">
              L
            </div>
            <span class="text-2xl font-bold tracking-tight">LivestockMart</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-bold leading-tight mb-4">
            Buy goats & sheep<br>with an Amazon-style checkout.
          </h1>
          <p class="text-sm text-emerald-100/80">
            Secure login, realtime orders, UPI & card payments, and live order tracking ‚Äì all from one modern dashboard.
          </p>
        </div>
        <div class="flex items-center gap-3 text-xs text-emerald-100/70 mt-8">
          <i data-lucide="shield-check" class="w-4 h-4"></i>
          <span>Secure authentication ‚Ä¢ Payments to <b>sai.kambala@ybl</b> via UPI</span>
        </div>
      </div>

      <!-- Auth Card -->
      <div id="auth-card" class="bg-white/95 rounded-3xl p-6 sm:p-8 shadow-2xl border border-white/40">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-9 h-9 rounded-full bg-emerald-500/10 flex items-center justify-center">
            <i data-lucide="lock" class="w-4 h-4 text-emerald-500"></i>
          </div>
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Welcome back</h2>
            <p class="text-xs text-gray-500">Login or create an account to continue</p>
          </div>
        </div>

        <div class="flex text-xs mb-4 bg-gray-100 rounded-full p-1">
          <button id="tab-login" class="flex-1 py-2 rounded-full bg-white shadow text-gray-900 font-medium">Login</button>
          <button id="tab-register" class="flex-1 py-2 rounded-full text-gray-500">Register</button>
        </div>

        <!-- Login -->
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-xs font-medium mb-1">Email</label>
            <input id="login-email" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Password</label>
            <input id="login-password" type="password" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <p id="auth-error" class="text-xs text-red-500 min-h-[16px]"></p>
          <button type="submit" class="w-full bg-emerald-600 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-emerald-700 flex items-center justify-center gap-2">
            <span>Login</span>
          </button>
        </form>

        <!-- Register -->
        <form id="register-form" class="space-y-4 hidden">
          <div>
            <label class="block text-xs font-medium mb-1">Full Name</label>
            <input id="register-name" type="text" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Email</label>
            <input id="register-email" type="email" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Password</label>
            <input id="register-password" type="password" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" />
          </div>
          <button type="submit" class="w-full bg-emerald-600 text-white py-2.5 rounded-lg text-sm font-medium hover:bg-emerald-700 flex items-center justify-center gap-2">
            <span>Create account</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="user-app" class="hidden min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-4 md:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-full bg-emerald-600 flex items-center justify-center text-white font-bold">L</div>
        <div>
          <h1 id="page-title" class="text-lg md:text-2xl font-bold text-gray-900">My Dashboard</h1>
          <p id="current-date" class="text-xs text-gray-500"></p>
        </div>
      </div>
      <div class="flex items-center gap-5">
        <!-- Cart: icon + badge -->
        <button class="relative flex items-center justify-center" onclick="router('cart')">
          <span class="text-2xl leading-none">üõí</span>
          <span id="header-cart-badge" class="absolute -top-2 -right-3 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
        </button>

        <!-- Profile -->
        <div class="relative">
          <button onclick="toggleProfileMenu()" class="flex items-center gap-2">
            <div id="profile-avatar" class="w-8 h-8 rounded-full bg-emerald-600 text-white text-xs flex items-center justify-center font-semibold">
              U
            </div>
            <div class="hidden md:block text-left">
              <p id="profile-name" class="text-sm font-semibold">User</p>
              <p id="profile-meta" class="text-xs text-gray-500">Welcome</p>
            </div>
            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 hidden md:block"></i>
          </button>
          <div id="profile-menu" class="absolute right-0 mt-2 w-44 bg-white border border-gray-100 rounded-lg shadow-lg py-1 hidden">
            <button onclick="router('profile'); toggleProfileMenu(false);" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
              <i data-lucide="user" class="w-4 h-4"></i><span>Profile</span>
            </button>
            <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
              <i data-lucide="log-out" class="w-4 h-4"></i><span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <div class="flex flex-1 min-h-0">
      <!-- Sidebar -->
      <nav class="hidden md:block w-60 bg-white border-r border-gray-100 p-4 space-y-2">
        <button class="nav-item w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100 bg-green-600 text-white" onclick="router('dashboard')">
          <i data-lucide="home" class="w-4 h-4"></i><span>Dashboard</span>
        </button>
        <button class="nav-item w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100" onclick="router('browse')">
          <i data-lucide="cow" class="w-4 h-4"></i><span>Browse Livestock</span>
        </button>
        <button class="nav-item w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100" onclick="router('cart')">
          <i data-lucide="shopping-cart" class="w-4 h-4"></i><span>Cart</span>
        </button>
        <button class="nav-item w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-100" onclick="router('orders')">
          <i data-lucide="receipt" class="w-4 h-4"></i><span>My Orders</span>
        </button>
      </nav>

      <!-- Content -->
      <main id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 hide-scrollbar">
        <!-- Dashboard -->
        <section id="view-dashboard" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-500">Total Livestock</p>
                <p id="dash-total-livestock" class="text-xl font-bold">0</p>
              </div>
              <div class="w-9 h-9 rounded-full bg-emerald-50 flex items-center justify-center">
                <i data-lucide="cow" class="w-5 h-5 text-emerald-600"></i>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-500">Orders</p>
                <p id="dash-total-orders" class="text-xl font-bold">0</p>
              </div>
              <div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center">
                <i data-lucide="receipt" class="w-5 h-5 text-blue-600"></i>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-500">Wishlist</p>
                <p id="dash-total-wishlist" class="text-xl font-bold">0</p>
              </div>
              <div class="w-9 h-9 rounded-full bg-pink-50 flex items-center justify-center">
                <i data-lucide="heart" class="w-5 h-5 text-pink-500"></i>
              </div>
            </div>
            <div class="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
              <div>
                <p class="text-xs text-gray-500">Total Spent</p>
                <p id="dash-total-spent" class="text-xl font-bold">‚Çπ0</p>
              </div>
              <div class="w-9 h-9 rounded-full bg-amber-50 flex items-center justify-center">
                <i data-lucide="indian-rupee" class="w-5 h-5 text-amber-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded-xl border shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-gray-800">Recent orders</h3>
            </div>
            <div id="dash-recent-orders" class="space-y-3 text-sm text-gray-600">
              <p>No orders yet.</p>
            </div>
          </div>
        </section>

        <!-- Browse -->
        <section id="view-browse" class="hidden space-y-4">
          <h2 class="text-lg font-semibold mb-3">Browse Livestock</h2>
          <div id="browse-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <!-- Cart -->
        <section id="view-cart" class="hidden space-y-4">
          <h2 class="text-lg font-semibold mb-3">Your Cart</h2>
          <div id="cart-list" class="space-y-3"></div>
          <div id="cart-summary" class="hidden bg-white p-4 rounded-xl border shadow-sm flex items-center justify-between">
            <p class="text-sm text-gray-700">Total: <span id="cart-total" class="font-bold"></span></p>
            <button onclick="checkoutCart()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-emerald-700">
              Proceed to checkout
            </button>
          </div>
        </section>

        <!-- Orders -->
        <section id="view-orders" class="hidden space-y-4">
          <h2 class="text-lg font-semibold mb-3">My Orders</h2>
          <div id="orders-list" class="space-y-4"></div>
        </section>

        <!-- Profile -->
        <section id="view-profile" class="hidden space-y-4">
          <h2 class="text-lg font-semibold mb-3">My Profile</h2>
          <p class="text-sm text-gray-600">Profile details coming soon.</p>
        </section>
      </main>
    </div>
  </div>

  <!-- Order Summary Modal (Amazon style) -->
  <div id="order-summary-modal" class="fixed inset-0 z-30 hidden items-center justify-center bg-black/60">
    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl text-gray-800 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold">Review your order</h3>
        <button onclick="closeOrderSummary()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 space-y-4">
          <div>
            <h4 class="font-semibold mb-2">Items</h4>
            <div id="order-items" class="space-y-3"></div>
          </div>
          <div>
            <h4 class="font-semibold mb-2">Delivery address</h4>
            <div id="order-address" class="bg-gray-50 p-3 rounded-lg text-sm"></div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="border rounded-xl p-4 bg-amber-50/60">
            <h4 class="font-semibold mb-2">Payment method</h4>
            <!-- COD -->
            <label class="flex items-center gap-2 text-sm cursor-pointer mb-2">
              <input type="radio" name="payment" value="cod" onchange="selectPayment('cod')" />
              <span>Cash on Delivery</span>
            </label>
            <!-- UPI -->
            <label class="flex items-start gap-2 text-sm cursor-pointer mb-2">
              <input type="radio" name="payment" value="upi" onchange="selectPayment('upi')" />
              <div>
                <p class="font-medium">UPI to <span class="font-mono text-emerald-700">sai.kambala@ybl</span></p>
                <p class="text-xs text-gray-600">Pay using any UPI app (GPay, PhonePe, Paytm...)</p>
              </div>
            </label>
            <!-- Card -->
            <label class="flex items-start gap-2 text-sm cursor-pointer">
              <input type="radio" name="payment" value="card" onchange="selectPayment('card')" />
              <div>
                <p class="font-medium">Credit / Debit Card</p>
                <p class="text-xs text-gray-600">Processed by your secure payment gateway (no card details stored here).</p>
              </div>
            </label>
          </div>

          <div class="border rounded-xl p-4 space-y-1 text-sm">
            <div class="flex justify-between">
              <span>Items:</span><span id="order-subtotal">‚Çπ0</span>
            </div>
            <div class="flex justify-between">
              <span>Delivery:</span><span id="order-delivery">‚Çπ0</span>
            </div>
            <div class="border-t pt-2 mt-1 flex justify-between font-semibold">
              <span>Order total:</span><span id="order-total">‚Çπ0</span>
            </div>
          </div>

          <button onclick="confirmOrder()" class="w-full bg-emerald-600 text-white py-2.5 rounded-lg text-sm font-semibold hover:bg-emerald-700">
            Place your order
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md text-gray-800 shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold" id="payment-modal-title">Complete Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- UPI Payment -->
      <div id="upi-form" class="hidden space-y-4">
        <div class="bg-gray-50 p-3 rounded-lg text-sm">
          <p class="font-medium text-gray-800">Pay to this UPI ID</p>
          <div class="mt-1 flex items-center justify-between gap-2">
            <span id="upi-merchant-id" class="font-mono text-green-700 text-sm">
              sai.kambala@ybl
            </span>
            <button type="button" onclick="copyUpiId()" class="text-xs px-2 py-1 rounded-lg border border-emerald-500 text-emerald-600 hover:bg-emerald-50">
              Copy
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Use any UPI app and pay this ID. Amount: <span id="upi-amount" class="font-semibold">‚Çπ0</span>
          </p>
        </div>

        <div class="space-y-2">
          <p class="text-xs text-gray-500">Quick launch:</p>
          <div class="grid grid-cols-2 gap-2">
            <button type="button" onclick="payWithUpiApp('generic')" class="flex items-center justify-center gap-2 border rounded-lg py-2 text-sm hover:bg-gray-50">
              Any UPI app
            </button>
            <button type="button" onclick="payWithUpiApp('gpay')" class="flex items-center justify-center gap-2 border rounded-lg py-2 text-sm hover:bg-gray-50">
              Google Pay
            </button>
            <button type="button" onclick="payWithUpiApp('phonepe')" class="flex items-center justify-center gap-2 border rounded-lg py-2 text-sm hover:bg-gray-50">
              PhonePe
            </button>
            <button type="button" onclick="payWithUpiApp('paytm')" class="flex items-center justify-center gap-2 border rounded-lg py-2 text-sm hover:bg-gray-50">
              Paytm
            </button>
          </div>
        </div>

        <button type="button" onclick="confirmUpiPaymentDone()" class="w-full bg-green-600 text-white py-2.5 rounded-lg hover:bg-green-700 text-sm font-medium">
          I have completed payment in my UPI app
        </button>
        <p class="text-[11px] text-gray-400">
          This site never asks for your UPI PIN. You pay inside your app only.
        </p>
      </div>

      <!-- Card Payment -->
      <div id="card-form" class="hidden space-y-4">
        <div class="bg-gray-50 p-3 rounded-lg text-sm">
          <p class="font-medium text-gray-800">Credit / Debit Card</p>
          <p class="text-xs text-gray-500 mt-1">
            Integrate Razorpay / Stripe / any gateway here. This demo only simulates a successful payment ‚Äì no card data is stored.
          </p>
        </div>
        <button type="button" onclick="startCardGatewayCheckout()" class="w-full bg-green-600 text-white py-2.5 rounded-lg hover:bg-green-700 text-sm font-medium">
          Continue to secure card payment
        </button>
      </div>

      <!-- Success -->
      <div id="payment-success" class="hidden text-center py-8">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="check" class="w-8 h-8 text-green-600"></i>
        </div>
        <h3 class="text-lg font-semibold mb-2">Order placed!</h3>
        <p class="text-gray-600 mb-4">
          Your order has been created. Track its status from the Orders page.
        </p>
        <button onclick="goToOrders()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 text-sm">
          View orders
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
    <div id="toast-inner" class="px-4 py-2 rounded-lg text-sm shadow-lg bg-gray-900 text-white"></div>
  </div>

  <script>
    const API_URL = '';
    let currentUser = null;
    let livestock = [];
    let orders = [];
    let cart = [];
    let wishlist = [];
    let addresses = [];
    let currentAddress = null;
    let currentOrderItems = [];
    let selectedPaymentMethod = null;
    let currentOrderTotal = 0;
    let appInitialized = false;

    function refreshIcons() {
      if (window.lucide) {
        window.lucide.createIcons();
      }
    }

    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      const inner = document.getElementById('toast-inner');
      inner.textContent = msg;
      inner.className =
        'px-4 py-2 rounded-lg text-sm shadow-lg text-white ' +
        (type === 'success'
          ? 'bg-emerald-600'
          : type === 'error'
          ? 'bg-red-600'
          : type === 'warning'
          ? 'bg-amber-500'
          : 'bg-gray-900');
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 2500);
    }

    function formatINR(amount) {
      return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        maximumFractionDigits: 0,
      }).format(amount || 0);
    }

    function showAuthError(msg) {
      const el = document.getElementById('auth-error');
      if (el) el.textContent = msg || '';
    }

    function getInitials(name) {
      if (!name) return 'U';
      return name
        .split(' ')
        .filter(Boolean)
        .map((n) => n[0].toUpperCase())
        .join('')
        .slice(0, 2);
    }

    function updateProfileUI() {
      const avatar = document.getElementById('profile-avatar');
      const nameEl = document.getElementById('profile-name');
      const metaEl = document.getElementById('profile-meta');
      const name = currentUser?.name || 'User';
      if (avatar) avatar.textContent = getInitials(name);
      if (nameEl) nameEl.textContent = name;
      if (metaEl) metaEl.textContent = 'Welcome back';
    }

    function toggleProfileMenu(force) {
      const menu = document.getElementById('profile-menu');
      if (!menu) return;
      if (typeof force === 'boolean') {
        if (force) menu.classList.remove('hidden');
        else menu.classList.add('hidden');
        return;
      }
      menu.classList.toggle('hidden');
    }

    async function handleLogin(e) {
      e.preventDefault();
      showAuthError('');
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      if (!email || !password) return showAuthError('Please enter email and password.');

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          return showAuthError(data.message || 'Login failed.');
        }
        currentUser = data.user;
        await loadUserState();
        updateProfileUI();
        updateCartBadge();
        showToast('Logged in', 'success');
        showApp();
      } catch (err) {
        console.error(err);
        showAuthError('Something went wrong. Please try again.');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      showAuthError('');
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();
      if (!name || !email || !password) return showAuthError('All fields are required.');

      try {
        const res = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, email, password }),
        });
        const data = await res.json();
        if (!res.ok) return showAuthError(data.message || 'Registration failed.');
        currentUser = data.user;
        await loadUserState();
        updateProfileUI();
        updateCartBadge();
        showToast('Account created', 'success');
        showApp();
      } catch (err) {
        console.error(err);
        showAuthError('Something went wrong. Please try again.');
      }
    }

    async function handleLogout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      } catch (err) {
        console.error(err);
      }
      currentUser = null;
      cart = [];
      wishlist = [];
      addresses = [];
      currentAddress = null;
      updateCartBadge();
      toggleProfileMenu(false);
      showToast('Logged out', 'info');
      showAuthScreen();
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (!res.ok) return showAuthScreen();
        const data = await res.json();
        currentUser = data.user;
        await loadUserState();
        updateProfileUI();
        updateCartBadge();
        showApp();
      } catch (err) {
        console.error(err);
        showAuthScreen();
      }
    }

    async function loadUserState() {
      try {
        const res = await fetch('/api/user/state', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        cart = data.cart || [];
        wishlist = data.wishlist || [];
        addresses = data.addresses || [];
        if (!currentAddress && addresses.length > 0) currentAddress = addresses[0];
      } catch (err) {
        console.error('state', err);
      }
    }

    async function saveUserState() {
      try {
        await fetch('/api/user/state', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ cart, wishlist, addresses }),
        });
      } catch (err) {
        console.error('save state', err);
      }
    }

    async function loadData() {
      try {
        const lsRes = await fetch('/api/livestock');
        livestock = await lsRes.json();
        const ordRes = await fetch('/api/orders', { credentials: 'include' });
        orders = await ordRes.json();
        const activeNav = document.querySelector('.nav-item.bg-green-600');
        let view = 'dashboard';
        if (activeNav) {
          const on = activeNav.getAttribute('onclick') || '';
          view = on.replace("router('", '').replace("')", '') || 'dashboard';
        }
        if (view === 'dashboard') renderDashboard();
        if (view === 'browse') renderBrowse();
        if (view === 'orders') renderOrders();
      } catch (e) {
        console.error(e);
        showToast('Failed to load data', 'error');
      }
    }

    function showApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('user-app').classList.remove('hidden');
      if (!appInitialized) {
        appInitialized = true;
        initApp();
      }
    }
    function showAuthScreen() {
      document.getElementById('user-app').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
    }

    function router(viewName) {
      loadData();
      const titles = {
        dashboard: 'My Dashboard',
        browse: 'Browse Livestock',
        cart: 'Shopping Cart',
        orders: 'My Orders',
        profile: 'My Profile',
      };
      document.getElementById('page-title').innerText = titles[viewName] || 'My Dashboard';

      ['dashboard', 'browse', 'cart', 'orders', 'profile'].forEach((v) =>
        document.getElementById('view-' + v)?.classList.add('hidden')
      );
      document.getElementById('view-' + viewName)?.classList.remove('hidden');

      document.querySelectorAll('.nav-item').forEach((btn) => {
        if (btn.getAttribute('onclick').includes(viewName)) {
          btn.classList.add('bg-green-600', 'text-white');
          btn.classList.remove('text-gray-700', 'hover:bg-gray-100');
        } else {
          btn.classList.remove('bg-green-600', 'text-white');
          btn.classList.add('text-gray-700', 'hover:bg-gray-100');
        }
      });

      if (viewName === 'dashboard') renderDashboard();
      if (viewName === 'browse') renderBrowse();
      if (viewName === 'cart') renderCart();
      if (viewName === 'orders') renderOrders();

      refreshIcons();
    }

    function renderDashboard() {
      const safeOrders = Array.isArray(orders) ? orders : [];
      const totalSpent = safeOrders.reduce((sum, o) => sum + (Number(o.total) || 0), 0);
      document.getElementById('dash-total-livestock').innerText = livestock.length;
      document.getElementById('dash-total-orders').innerText = safeOrders.length;
      document.getElementById('dash-total-wishlist').innerText = wishlist.length;
      document.getElementById('dash-total-spent').innerText = formatINR(totalSpent);

      const recentContainer = document.getElementById('dash-recent-orders');
      if (!safeOrders.length) {
        recentContainer.innerHTML = '<p class="text-sm text-gray-500">No orders yet.</p>';
        return;
      }
      const recent = safeOrders.slice(0, 3);
      recentContainer.innerHTML = recent
        .map((o) => {
          const itemsArray = Array.isArray(o.items) ? o.items : [];
          const first = itemsArray[0] || {};
          const title = first.name || 'Livestock order';
          const extra = itemsArray.length > 1 ? ` +${itemsArray.length - 1} more` : '';
          const id = o._id ? String(o._id).slice(-6) : '------';
          return `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
              <div>
                <p class="text-sm font-semibold text-gray-800">${title}${extra}</p>
                <p class="text-xs text-gray-500">#${id} ‚Ä¢ ${o.date || ''}</p>
              </div>
              <div class="text-right text-xs">
                <p class="font-semibold">${formatINR(o.total || 0)}</p>
                <p class="text-gray-500">${o.status || 'Processing'}</p>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function renderBrowse() {
      const grid = document.getElementById('browse-grid');
      if (!livestock.length) {
        grid.innerHTML = '<p class="text-sm text-gray-500 col-span-3">No livestock listed yet.</p>';
        return;
      }
      grid.innerHTML = livestock
        .map(
          (item) => `
        <div class="bg-white p-4 rounded-xl border shadow-sm flex flex-col">
          <div class="h-32 bg-gray-100 rounded-lg flex items-center justify-center text-6xl mb-3">
            ${item.image || 'üêê'}
          </div>
          <div class="flex-1 space-y-1 text-sm">
            <p class="font-semibold text-gray-800">${item.name}</p>
            <p class="text-gray-500">${item.breed}</p>
            <p class="text-xs text-gray-400">${item.type} ‚Ä¢ Age: ${item.age}</p>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <p class="font-bold text-emerald-700">${formatINR(item.price)}</p>
            <div class="flex gap-2">
              <button onclick="addToCart('${item._id}')" class="px-3 py-1.5 rounded-lg text-xs bg-emerald-600 text-white hover:bg-emerald-700">
                Add to cart
              </button>
              <button onclick="buyNow('${item._id}')" class="px-3 py-1.5 rounded-lg text-xs bg-amber-500 text-white hover:bg-amber-600">
                Buy now
              </button>
            </div>
          </div>
        </div>
      `
        )
        .join('');
      refreshIcons();
    }

    function renderCart() {
      const list = document.getElementById('cart-list');
      const summary = document.getElementById('cart-summary');
      if (!cart.length) {
        list.innerHTML = '<p class="text-sm text-gray-500">Your cart is empty.</p>';
        summary.classList.add('hidden');
        updateCartBadge();
        return;
      }
      list.innerHTML = cart
        .map(
          (item, idx) => `
        <div class="bg-white p-3 rounded-xl border shadow-sm flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-3xl">${item.image || 'üêê'}</div>
            <div class="text-sm">
              <p class="font-semibold text-gray-800">${item.name}</p>
              <p class="text-xs text-gray-500">${item.breed}</p>
            </div>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <p class="font-semibold">${formatINR(item.price)}</p>
            <button onclick="removeFromCart(${idx})" class="text-xs text-red-500 hover:text-red-600">Remove</button>
          </div>
        </div>
      `
        )
        .join('');
      const total = cart.reduce((sum, i) => sum + (i.price || 0), 0);
      document.getElementById('cart-total').textContent = formatINR(total);
      summary.classList.remove('hidden');
      updateCartBadge();
    }

    function updateCartBadge() {
      const badge = document.getElementById('header-cart-badge');
      if (!badge) return;
      const count = cart.length;
      badge.textContent = count;
      if (count > 0) badge.classList.remove('hidden');
      else badge.classList.add('hidden');
    }

    function addToCart(id) {
      const item = livestock.find((i) => i._id === id);
      if (!item) return;
      cart.push({ ...item });
      saveUserState();
      renderCart();
      renderDashboard();
      showToast('Added to cart', 'success');
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      saveUserState();
      renderCart();
    }

    function buyNow(id) {
      const item = livestock.find((i) => i._id === id);
      if (!item) return;
      currentOrderItems = [{ ...item }];
      showOrderSummary();
    }

    function checkoutCart() {
      if (!cart.length) return showToast('Your cart is empty', 'warning');
      currentOrderItems = cart.map((i) => ({ ...i }));
      showOrderSummary();
    }

    function showOrderSummary() {
      if (!currentOrderItems.length) return showToast('No items in order', 'error');

      const modal = document.getElementById('order-summary-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      const subtotal = currentOrderItems.reduce((s, i) => s + (i.price || 0), 0);
      const delivery = subtotal > 5000 ? 0 : 200;
      const total = subtotal + delivery;
      currentOrderTotal = total;

      const itemsEl = document.getElementById('order-items');
      itemsEl.innerHTML = currentOrderItems
        .map(
          (item) => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center text-2xl border">${item.image || 'üêê'}</div>
            <div>
              <p class="font-semibold text-gray-800">${item.name}</p>
              <p class="text-xs text-gray-500">${item.breed}</p>
            </div>
          </div>
          <p class="font-semibold">${formatINR(item.price)}</p>
        </div>
      `
        )
        .join('');

      const addrEl = document.getElementById('order-address');
      if (currentAddress) {
        addrEl.innerHTML = `
          <p class="font-semibold">${currentAddress.name}</p>
          <p>${currentAddress.line1}</p>
          ${currentAddress.line2 ? `<p>${currentAddress.line2}</p>` : ''}
          <p>${currentAddress.city}, ${currentAddress.state} - ${currentAddress.pincode}</p>
          <p>üì± +91 ${currentAddress.phone}</p>
        `;
      } else {
        addrEl.innerHTML = '<p class="text-sm text-gray-500">No address saved (address management omitted in this simplified build).</p>';
      }

      document.getElementById('order-subtotal').textContent = formatINR(subtotal);
      document.getElementById('order-delivery').textContent = delivery === 0 ? 'FREE' : formatINR(delivery);
      document.getElementById('order-total').textContent = formatINR(total);

      const upiAmountEl = document.getElementById('upi-amount');
      if (upiAmountEl) upiAmountEl.textContent = formatINR(total);
    }

    function closeOrderSummary() {
      const modal = document.getElementById('order-summary-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function selectPayment(method) {
      selectedPaymentMethod = method;
    }

    async function confirmOrder() {
      if (!selectedPaymentMethod) return showToast('Select a payment method', 'warning');
      if (selectedPaymentMethod === 'cod') {
        await createOrder();
      } else {
        closeOrderSummary();
        showPaymentModal(selectedPaymentMethod);
      }
    }

    async function createOrder() {
      try {
        const items = currentOrderItems.map((i) => ({
          id: i._id,
          name: i.name,
          price: i.price,
          breed: i.breed,
          image: i.image,
        }));
        const subtotal = currentOrderItems.reduce((s, i) => s + (i.price || 0), 0);
        const delivery = subtotal > 5000 ? 0 : 200;
        const total = subtotal + delivery;

        const body = {
          items,
          total,
          status: 'Processing',
          address: currentAddress
            ? {
                name: currentAddress.name,
                phone: currentAddress.phone,
                line: currentAddress.line1,
                city: currentAddress.city,
                state: currentAddress.state,
                pincode: currentAddress.pincode,
              }
            : null,
          paymentMethod: selectedPaymentMethod || 'cod',
        };

        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          console.error(data);
          return showToast('Failed to create order', 'error');
        }

        orders.unshift(data);
        currentOrderItems = [];
        cart = [];
        saveUserState();
        renderCart();
        renderDashboard();

        const upiForm = document.getElementById('upi-form');
        const cardForm = document.getElementById('card-form');
        const success = document.getElementById('payment-success');
        if (upiForm) upiForm.classList.add('hidden');
        if (cardForm) cardForm.classList.add('hidden');
        if (success) success.classList.remove('hidden');
        document.getElementById('payment-modal').classList.remove('hidden');
        document.getElementById('payment-modal').classList.add('flex');
      } catch (err) {
        console.error(err);
        showToast('Error placing order', 'error');
      }
    }

    function showPaymentModal(method) {
      const modal = document.getElementById('payment-modal');
      const title = document.getElementById('payment-modal-title');
      const upiForm = document.getElementById('upi-form');
      const cardForm = document.getElementById('card-form');
      const success = document.getElementById('payment-success');
      if (upiForm) upiForm.classList.add('hidden');
      if (cardForm) cardForm.classList.add('hidden');
      if (success) success.classList.add('hidden');

      if (method === 'upi') {
        title.textContent = 'UPI Payment';
        upiForm.classList.remove('hidden');
        const upiAmountEl = document.getElementById('upi-amount');
        if (upiAmountEl) upiAmountEl.textContent = formatINR(currentOrderTotal || 0);
      } else if (method === 'card') {
        title.textContent = 'Card Payment';
        cardForm.classList.remove('hidden');
      }

      modal.classList.remove('hidden');
      modal.classList.add('flex');
      refreshIcons();
    }

    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function copyUpiId() {
      const id = 'sai.kambala@ybl';
      if (navigator.clipboard) {
        navigator.clipboard
          .writeText(id)
          .then(() => showToast('UPI ID copied', 'success'))
          .catch(() => showToast('Unable to copy. Long-press to copy manually.', 'warning'));
      } else {
        showToast('Long-press to copy UPI ID', 'info');
      }
    }

    function buildUpiUrl() {
      const amount = Number(currentOrderTotal || 0);
      const pa = encodeURIComponent('sai.kambala@ybl');
      const pn = encodeURIComponent('LivestockMart');
      const tn = encodeURIComponent('Livestock order');
      const am = encodeURIComponent(amount.toFixed(2));
      const cu = 'INR';
      return `upi://pay?pa=${pa}&pn=${pn}&tn=${tn}&am=${am}&cu=${cu}`;
    }

    function payWithUpiApp(appType) {
      const url = buildUpiUrl();
      try {
        window.location.href = url;
        showToast('Opening UPI app...', 'info');
      } catch (e) {
        console.error(e);
        showToast('Could not open UPI app', 'error');
      }
    }

    function confirmUpiPaymentDone() {
      showToast('Marking order as paid via UPI', 'success');
      createOrder();
    }

    function startCardGatewayCheckout() {
      showToast('Simulating secure card payment...', 'info');
      createOrder();
    }

    function goToOrders() {
      closePaymentModal();
      router('orders');
    }

    async function cancelOrder(orderId) {
      try {
        const res = await fetch(`/api/orders/${orderId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'Cancelled' }),
        });
        const data = await res.json();
        if (!res.ok) {
          console.error(data);
          return showToast(data.error || 'Failed to cancel order', 'error');
        }
        const idx = orders.findIndex((o) => o._id === orderId);
        if (idx !== -1) orders[idx] = data;
        renderOrders();
        renderDashboard();
        showToast('Order cancelled', 'success');
      } catch (err) {
        console.error(err);
        showToast('Error cancelling order', 'error');
      }
    }

    function renderOrders() {
      const list = document.getElementById('orders-list');
      if (!orders.length) {
        list.innerHTML = '<p class="text-sm text-gray-500">You have no orders yet.</p>';
        return;
      }
      list.innerHTML = orders
        .map((order) => {
          const id = order._id ? String(order._id).slice(-6) : '------';
          const itemsArray = Array.isArray(order.items) ? order.items : [];
          const first = itemsArray[0] || {};
          const extra = itemsArray.length > 1 ? ` +${itemsArray.length - 1} more` : '';
          const paymentBadge =
            order.paymentMethod === 'upi'
              ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Paid via UPI</span>'
              : order.paymentMethod === 'card'
              ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Paid via card</span>'
              : '<span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full">Cash on delivery</span>';

          let statusBadge = '';
          if (order.status === 'Cancelled') {
            statusBadge = '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">Cancelled</span>';
          } else if (order.status === 'Delivered') {
            statusBadge = '<span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full">Delivered</span>';
          } else {
            statusBadge = `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">${order.status}</span>`;
          }

          const steps = order.tracking || [
            { label: 'Order Placed', completed: true },
            { label: 'Packed', completed: false },
            { label: 'Shipped', completed: false },
            { label: 'Delivered', completed: false },
          ];

          const trackHtml = `
            <div class="mt-3">
              <div class="flex justify-between text-[11px] text-gray-500 mb-2">
                ${steps
                  .map(
                    (s) => `
                  <div class="flex-1 flex flex-col items-center ${s.completed ? 'text-emerald-600' : ''}">
                    <div class="w-6 h-6 rounded-full flex items-center justify-center border ${
                      s.completed ? 'bg-emerald-500 text-white border-emerald-500 step-active' : 'bg-white border-gray-300'
                    }">
                      ${s.completed ? '‚úì' : ''}
                    </div>
                    <span class="mt-1 text-[10px] text-center">${s.label}</span>
                  </div>
                `
                  )
                  .join('')}
              </div>
              <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-500 transition-all" style="width:${
                  (steps.filter((s) => s.completed).length / steps.length) * 100
                }%"></div>
              </div>
            </div>
          `;

          return `
            <div class="bg-white p-4 rounded-xl border shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold text-gray-800">Order #${id}</p>
                  <p class="text-xs text-gray-500">${order.date || ''}</p>
                  <p class="text-xs text-gray-500 mt-1">${first.name || 'Livestock order'}${extra}</p>
                  <p class="text-sm font-semibold mt-1">${formatINR(order.total || 0)}</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                  ${statusBadge}
                  ${paymentBadge}
                  ${
                    order.status === 'Processing' || order.status === 'Packed'
                      ? `<button onclick="cancelOrder('${order._id}')" class="mt-1 text-xs text-red-600 hover:text-red-700">Cancel order</button>`
                      : ''
                  }
                </div>
              </div>
              ${trackHtml}
            </div>
          `;
        })
        .join('');
    }

    function initApp() {
      document.getElementById('current-date').textContent = new Date().toLocaleString('en-IN', {
        weekday: 'short',
        day: '2-digit',
        month: 'short',
        year: 'numeric',
      });
      router('dashboard');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const tabLogin = document.getElementById('tab-login');
      const tabRegister = document.getElementById('tab-register');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');

      tabLogin.addEventListener('click', () => {
        tabLogin.classList.add('bg-white', 'shadow', 'text-gray-900');
        tabRegister.classList.remove('bg-white', 'shadow', 'text-gray-900');
        tabRegister.classList.add('text-gray-500');
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      });
      tabRegister.addEventListener('click', () => {
        tabRegister.classList.add('bg-white', 'shadow', 'text-gray-900');
        tabLogin.classList.remove('bg-white', 'shadow', 'text-gray-900');
        tabLogin.classList.add('text-gray-500');
        registerForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      });

      loginForm.addEventListener('submit', handleLogin);
      registerForm.addEventListener('submit', handleRegister);
      checkAuth();
      refreshIcons();
    });
  </script>
</body>
</html>
